@using ClassLibrary
@model FormSubmissionViewModel

<form asp-action="SubmitForm" method="post" id="dynamic-form" class="container mt-4">
    <input type="hidden" name="FormId" value="@Model.FormId" />
    <input type="hidden" name="RowId" value="@Model.RowId" />
    <input type="hidden" name="TargetTableToUpsert" value="@Model.TargetTableToUpsert" />

    <div class="row g-4">
        @for (var i = 0; i < Model.Fields.Count; i++)
        {
            var field = Model.Fields[i];
            if (!field.IS_VISIBLE) { continue; }

            var colSize = "col-md-4";

            // var isRequired = field.ValidationRules.Any(r => r.VALIDATION_TYPE == ValidationType.Required);
            var isRequired = false;
            var maxLength = field.ValidationRules.FirstOrDefault(r => r.VALIDATION_TYPE == ValidationType.Max)?.VALIDATION_VALUE;
            var controlType = field.CONTROL_TYPE;

            <div class="@colSize">
                <input type="hidden" name="InputFields[@i].FieldConfigId" value="@field.FieldConfigId" />
                <input type="hidden" name="InputFields[@i].Column" value="@field.Column" />
                <input type="hidden" name="InputFields[@i].SOURCE_TABLE" value="@field.SOURCE_TABLE" />
                @if (controlType == FormControlType.Textarea)
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-body py-3 px-4">
                            <!-- 放每個欄位的標籤 + 控制元件 -->
                            <div class="row align-items-center">
                                <!-- 左側標籤區 -->
                                <div class="col-md-4 text-md-end text-muted fw-semibold">
                                    @if (isRequired)
                                    {
                                        <span class="text-danger">*</span>
                                    }
                                    @field.Column
                                </div>

                                <!-- 右側輸入區 -->
                                <div class="col-md-8">
                                    <textarea name="InputFields[@i].Value" class="form-control" maxlength="@maxLength" @(field.IS_EDITABLE ? "" : "disabled")>@(field.CurrentValue ?? field.DefaultValue)</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (controlType == FormControlType.Dropdown)
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-body py-3 px-4">
                            <!-- 放每個欄位的標籤 + 控制元件 -->
                            <div class="row align-items-center">
                                <!-- 左側標籤區 -->
                                <div class="col-md-4 text-md-end text-muted fw-semibold">
                                    @if (isRequired)
                                    {
                                        <span class="text-danger">*</span>
                                    }
                                    @field.Column
                                </div>

                                <!-- 右側輸入區 -->
                                <div class="col-md-8">
                                    <select name="InputFields[@i].Value"
                                            class="form-select dynamic-dropdown"
                                            data-id="@field.FieldConfigId"
                                            data-usesql="@field.ISUSESQL.ToString().ToLower()"
                                            data-sql="@Html.Raw(field.DROPDOWNSQL)"
                                            @(field.IS_EDITABLE ? "" : "disabled")>
                                        <option value="">-- 請選擇 --</option>
                                        @foreach (var opt in field.OptionList ?? new())
                                        {
                                            var selected = field.CurrentValue is Guid gid && gid == opt.ID;
                                            <option value="@opt.ID" selected="@(selected ? "selected" : null)">@opt.OPTION_TEXT</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (controlType == FormControlType.Checkbox)
                {
                    <div class="form-check mt-1">
                        <input type="checkbox"
                               name="InputFields[@i].Value"
                               value="true"
                               class="form-check-input"
                               @(field.IS_EDITABLE ? "" : "disabled") />
                        <label class="form-check-label">啟用</label>
                    </div>
                }
                else
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-body py-3 px-4">
                            <!-- 放每個欄位的標籤 + 控制元件 -->
                            <div class="row align-items-center">
                                <!-- 左側標籤區 -->
                                <div class="col-md-4 text-md-end text-muted fw-semibold">
                                    @if (isRequired)
                                    {
                                        <span class="text-danger">*</span>
                                    }
                                    @field.Column
                                </div>

                                <!-- 右側輸入區 -->
                                <div class="col-md-8">
                                    <input type="text"
                                           name="InputFields[@i].Value"
                                           class="form-control"
                                           maxlength="@maxLength"
                                           value="@(field.CurrentValue)"
                                           @(isRequired ? "required" : "")
                                           @(field.IS_EDITABLE ? "" : "disabled") />
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <div class="mt-5 text-center">
        <button type="submit" class="btn btn-primary px-5 py-2 fs-5 shadow-sm">
            <i class="bi bi-send-fill me-2"></i> 送出表單
        </button>
    </div>
</form>